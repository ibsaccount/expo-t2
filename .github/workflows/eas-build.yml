name: EAS Build

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select Environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      
      platform:
        description: 'Select Platform to Build'
        required: true
        default: 'All'
        type: choice
        options:
          - All
          - Android
          - iOS
      
      profile:
        description: 'Custom Build Profile (optional - overrides environment)'
        required: false
        type: string

  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

jobs:
  # Run tests and generate coverage reports first
  test_and_coverage:
    name: ğŸ§ª Test & Coverage
    runs-on: ubuntu-latest
    outputs:
      test_status: ${{ steps.test.outputs.status }}
      coverage_threshold_met: ${{ steps.test.outputs.coverage_threshold_met }}
    
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint
        continue-on-error: true

      - name: ğŸ§ª Run tests with coverage
        id: test
        run: |
          echo "ğŸ§ª Running tests with coverage generation..."
          
          # Run tests with coverage
          npm run test:ci
          
          # Check if tests passed
          if [ $? -eq 0 ]; then
            echo "âœ… All tests passed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Some tests failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check if coverage directory exists
          if [ -d "coverage" ]; then
            echo "ğŸ“Š Coverage report generated successfully"
            
            # Extract coverage percentage from coverage-summary.json (for reporting only)
            if [ -f "coverage/coverage-summary.json" ]; then
              COVERAGE=$(cat coverage/coverage-summary.json | node -pe "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).total.lines.pct || 0")
              echo "ğŸ“ˆ Line coverage: $COVERAGE%"
              
              # Always pass coverage check - ignoring threshold
              echo "âœ… Coverage check skipped (threshold ignored)"
              echo "coverage_threshold_met=true" >> $GITHUB_OUTPUT
              echo "coverage_percentage=$COVERAGE" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Coverage summary file not found, skipping coverage check"
              echo "coverage_threshold_met=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸  Coverage directory not found"
            echo "coverage_threshold_met=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Generate test results summary
        if: always()
        run: |
          echo "## ğŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test.outputs.status }}" == "success" ]; then
            echo "âœ… **All tests passed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.test.outputs.coverage_percentage }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ˆ Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "- **Line Coverage**: ${{ steps.test.outputs.coverage_percentage }}%" >> $GITHUB_STEP_SUMMARY
            echo "- **Threshold**: â­ï¸ Ignored (build always proceeds)" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: âœ… Build proceeds regardless of coverage" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¥ **Download Coverage Reports**: Check the artifacts section below" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            coverage/
            !coverage/tmp/
          retention-days: 30

      - name: ğŸ“¤ Upload coverage reports
        if: always() && steps.test.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: |
            coverage/
            !coverage/tmp/
          retention-days: 30

      - name: ï¿½ Upload coverage to artifacts (HTML)
        if: always() && steps.test.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-report-${{ github.run_number }}
          path: coverage/lcov-report/
          retention-days: 30

  validate_inputs:
    name: ï¿½ğŸ” Validate Build Inputs
    runs-on: ubuntu-latest
    needs: test_and_coverage
    # Only run validation if tests pass (unless forced via workflow_dispatch)
    if: needs.test_and_coverage.outputs.test_status == 'success' || github.event_name == 'workflow_dispatch'
    outputs:
      should_build_android: ${{ steps.validate.outputs.should_build_android }}
      should_build_ios: ${{ steps.validate.outputs.should_build_ios }}
      android_build_types: ${{ steps.validate.outputs.android_build_types }}
      
    steps:
      - name: ğŸ“ Validate and Process Inputs
        id: validate
        run: |
          echo "ğŸ” Starting input validation..."
          echo "Event type: ${{ github.event_name }}"
          
          # Set defaults based on event type
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PLATFORM="${{ github.event.inputs.platform }}"
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            # Defaults for push/PR events
            PLATFORM="All"
            ENVIRONMENT="development"
            echo "ğŸ“‹ Using defaults for ${{ github.event_name }} event"
          fi
          
          # Determine what to build based on platform selection
          case "$PLATFORM" in
            "All")
              BUILD_ANDROID="true"
              BUILD_IOS="true"
              echo "ğŸš€ Building for ALL platforms (Android + iOS)"
              ;;
            "Android")
              BUILD_ANDROID="true"
              BUILD_IOS="false"
              echo "ğŸ¤– Building for ANDROID only"
              ;;
            "iOS")
              BUILD_ANDROID="false"
              BUILD_IOS="true"
              echo "ğŸ Building for iOS only"
              ;;
            *)
              echo "âŒ Error: Invalid platform selection: $PLATFORM"
              exit 1
              ;;
          esac
          
          # Show current input values
          echo "ï¿½ Build Summary:"
          echo "  - Platform: $PLATFORM"
          echo "  - Build Android: $BUILD_ANDROID"
          echo "  - Build iOS: $BUILD_IOS"
          echo "  - Environment: $ENVIRONMENT"
          echo ""
          
          # Set outputs
          echo "should_build_android=$BUILD_ANDROID" >> $GITHUB_OUTPUT
          echo "should_build_ios=$BUILD_IOS" >> $GITHUB_OUTPUT
          
          # For Android builds, always build both APK and AAB
          ANDROID_TYPES="[]"
          if [ "$BUILD_ANDROID" == "true" ]; then
            ANDROID_TYPES='["apk","aab"]'
            echo "ğŸ“¦ Android build types: APK and AAB (both will be built)"
            echo "ğŸ¯ Final Android build types: $ANDROID_TYPES"
            echo "ğŸ“Š JSON validation: $(echo "$ANDROID_TYPES" | jq . 2>/dev/null && echo "âœ… Valid JSON" || echo "âŒ Invalid JSON")"
          fi
          echo "android_build_types=$ANDROID_TYPES" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Input validation completed successfully!"

  build_android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [test_and_coverage, validate_inputs]
    if: needs.validate_inputs.outputs.should_build_android == 'true' && needs.test_and_coverage.outputs.test_status == 'success'
    strategy:
      matrix:
        build_type: ${{ fromJson(needs.validate_inputs.outputs.android_build_types) }}
      fail-fast: false
    
    steps:
      - name: ğŸ“¦ Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "âŒ You must set EXPO_TOKEN secret in your repository settings"
            echo "ğŸ”— Visit: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "ğŸ“– Get your token from: https://expo.dev/accounts/[account]/settings/access-tokens"
            exit 1
          fi

      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Set Environment Variables
        run: |
          ENV="${{ github.event.inputs.environment || 'development' }}"
          echo "Selected environment: $ENV"
          
          # Copy the appropriate env file
          if [ -f ".env.${ENV}" ]; then
            echo "ğŸ“„ Using .env.${ENV}"
            cp ".env.${ENV}" .env.local
          else
            echo "âš ï¸  Environment file .env.${ENV} not found, using default"
            cp .env .env.local
          fi
          
          # Show environment info (without secrets)
          echo "ğŸŒ Environment configuration:"
          grep -E "^EXPO_PUBLIC_" .env.local | head -5

      - name: ğŸ“ Determine build profile
        id: build_profile
        run: |
          CUSTOM_PROFILE="${{ github.event.inputs.profile }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'development' }}"
          BUILD_TYPE="${{ matrix.build_type }}"
          
          if [ -n "$CUSTOM_PROFILE" ]; then
            PROFILE="$CUSTOM_PROFILE"
            echo "ğŸ¯ Using custom profile: $PROFILE"
          else
            if [ "$BUILD_TYPE" == "aab" ] && [ "$ENVIRONMENT" != "development" ]; then
              PROFILE="${ENVIRONMENT}-aab"
            else
              PROFILE="$ENVIRONMENT"
            fi
            echo "ğŸ¯ Using generated profile: $PROFILE"
          fi
          
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT

      - name: ğŸ— Build Android ${{ matrix.build_type }}
        id: build
        run: |
          echo "ğŸ¤– Building Android ${{ matrix.build_type }} with profile: ${{ steps.build_profile.outputs.profile }}"
          
          # Start the build and capture the build URL
          BUILD_OUTPUT=$(eas build --platform android --profile ${{ steps.build_profile.outputs.profile }} --non-interactive 2>&1)
          echo "$BUILD_OUTPUT"
          
          # Extract build URL and ID
          BUILD_URL=$(echo "$BUILD_OUTPUT" | grep -o 'https://expo.dev/accounts/[^/]*/projects/[^/]*/builds/[a-f0-9-]*' | head -1)
          BUILD_ID=$(echo "$BUILD_URL" | grep -o '[a-f0-9-]*$')
          
          if [ -z "$BUILD_URL" ]; then
            echo "âŒ Failed to extract build URL"
            exit 1
          fi
          
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“± Build started: $BUILD_URL"
        env:
          NODE_ENV: ${{ steps.build_profile.outputs.environment }}

      - name: â³ Wait for build completion
        id: wait
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"
          echo "â³ Waiting for build $BUILD_ID to complete..."
          
          # Wait for build to complete with timeout
          TIMEOUT=3600  # 1 hour timeout
          ELAPSED=0
          SLEEP_TIME=30
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Get build status
            STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status')
            
            case $STATUS in
              "FINISHED")
                echo "âœ… Build completed successfully!"
                
                # Get build artifacts
                BUILD_INFO=$(eas build:view $BUILD_ID --json)
                ARTIFACT_URL=$(echo "$BUILD_INFO" | jq -r '.artifacts.buildUrl // empty')
                
                if [ -n "$ARTIFACT_URL" ] && [ "$ARTIFACT_URL" != "null" ]; then
                  echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
                  echo "ğŸ“¥ Artifact available at: $ARTIFACT_URL"
                else
                  echo "âš ï¸ No artifact URL found"
                fi
                
                echo "status=success" >> $GITHUB_OUTPUT
                exit 0
                ;;
              "ERRORED"|"CANCELED")
                echo "âŒ Build failed with status: $STATUS"
                echo "status=failed" >> $GITHUB_OUTPUT
                exit 1
                ;;
              "IN_QUEUE"|"IN_PROGRESS")
                echo "ğŸ”„ Build status: $STATUS (elapsed: ${ELAPSED}s)"
                ;;
              *)
                echo "ğŸ¤” Unknown status: $STATUS"
                ;;
            esac
            
            sleep $SLEEP_TIME
            ELAPSED=$((ELAPSED + SLEEP_TIME))
          done
          
          echo "âŒ Build timed out after $TIMEOUT seconds"
          echo "status=timeout" >> $GITHUB_OUTPUT
          exit 1

      - name: ğŸ“¥ Download build artifact
        if: steps.wait.outputs.artifact_url != ''
        run: |
          ARTIFACT_URL="${{ steps.wait.outputs.artifact_url }}"
          BUILD_TYPE="${{ matrix.build_type }}"
          ENVIRONMENT="${{ steps.build_profile.outputs.environment }}"
          
          # Create downloads directory
          mkdir -p downloads
          
          # Determine file extension
          if [ "$BUILD_TYPE" == "aab" ]; then
            EXT="aab"
          else
            EXT="apk"
          fi
          
          # Download the artifact
          FILENAME="android-${ENVIRONMENT}-${BUILD_TYPE}.${EXT}"
          echo "ğŸ“¥ Downloading $FILENAME from $ARTIFACT_URL"
          
          curl -L -o "downloads/$FILENAME" "$ARTIFACT_URL"
          
          # Verify download
          if [ -f "downloads/$FILENAME" ]; then
            FILE_SIZE=$(stat -c%s "downloads/$FILENAME" 2>/dev/null || stat -f%z "downloads/$FILENAME")
            echo "âœ… Downloaded $FILENAME (${FILE_SIZE} bytes)"
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to download artifact"
            exit 1
          fi

      - name: ğŸ“¤ Upload build artifact
        if: steps.wait.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ steps.build_profile.outputs.environment }}-${{ matrix.build_type }}-${{ github.run_number }}
          path: downloads/
          retention-days: 30

  build_ios:
    name: ğŸ Build iOS
    runs-on: ubuntu-latest
    needs: [test_and_coverage, validate_inputs]
    if: needs.validate_inputs.outputs.should_build_ios == 'true' && needs.test_and_coverage.outputs.test_status == 'success'
    
    steps:
      - name: ğŸ“¦ Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "âŒ You must set EXPO_TOKEN secret in your repository settings"
            echo "ğŸ”— Visit: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "ğŸ“– Get your token from: https://expo.dev/accounts/[account]/settings/access-tokens"
            exit 1
          fi

      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Set Environment Variables
        run: |
          ENV="${{ github.event.inputs.environment || 'development' }}"
          echo "Selected environment: $ENV"
          
          # Copy the appropriate env file
          if [ -f ".env.${ENV}" ]; then
            echo "ğŸ“„ Using .env.${ENV}"
            cp ".env.${ENV}" .env.local
          else
            echo "âš ï¸  Environment file .env.${ENV} not found, using default"
            cp .env .env.local
          fi
          
          # Show environment info (without secrets)
          echo "ğŸŒ Environment configuration:"
          grep -E "^EXPO_PUBLIC_" .env.local | head -5

      - name: ğŸ“ Determine build profile
        id: build_profile
        run: |
          CUSTOM_PROFILE="${{ github.event.inputs.profile }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'development' }}"
          
          if [ -n "$CUSTOM_PROFILE" ]; then
            PROFILE="$CUSTOM_PROFILE"
            echo "ğŸ¯ Using custom profile: $PROFILE"
          else
            PROFILE="$ENVIRONMENT"
            echo "ğŸ¯ Using generated profile: $PROFILE"
          fi
          
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT

      - name: ğŸ— Build iOS
        id: build
        run: |
          echo "ğŸ Building iOS with profile: ${{ steps.build_profile.outputs.profile }}"
          
          # Start the build and capture the build URL
          BUILD_OUTPUT=$(eas build --platform ios --profile ${{ steps.build_profile.outputs.profile }} --non-interactive 2>&1)
          echo "$BUILD_OUTPUT"
          
          # Extract build URL and ID
          BUILD_URL=$(echo "$BUILD_OUTPUT" | grep -o 'https://expo.dev/accounts/[^/]*/projects/[^/]*/builds/[a-f0-9-]*' | head -1)
          BUILD_ID=$(echo "$BUILD_URL" | grep -o '[a-f0-9-]*$')
          
          if [ -z "$BUILD_URL" ]; then
            echo "âŒ Failed to extract build URL"
            exit 1
          fi
          
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ğŸ Build started: $BUILD_URL"
        env:
          NODE_ENV: ${{ steps.build_profile.outputs.environment }}

      - name: â³ Wait for iOS build completion
        id: wait
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"
          echo "â³ Waiting for iOS build $BUILD_ID to complete..."
          
          # Wait for build to complete with timeout
          TIMEOUT=3600  # 1 hour timeout
          ELAPSED=0
          SLEEP_TIME=30
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Get build status
            STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status')
            
            case $STATUS in
              "FINISHED")
                echo "âœ… iOS build completed successfully!"
                echo "status=success" >> $GITHUB_OUTPUT
                exit 0
                ;;
              "ERRORED"|"CANCELED")
                echo "âŒ iOS build failed with status: $STATUS"
                echo "status=failed" >> $GITHUB_OUTPUT
                exit 1
                ;;
              "IN_QUEUE"|"IN_PROGRESS")
                echo "ğŸ”„ iOS build status: $STATUS (elapsed: ${ELAPSED}s)"
                ;;
              *)
                echo "ğŸ¤” Unknown status: $STATUS"
                ;;
            esac
            
            sleep $SLEEP_TIME
            ELAPSED=$((ELAPSED + SLEEP_TIME))
          done
          
          echo "âŒ iOS build timed out after $TIMEOUT seconds"
          echo "status=timeout" >> $GITHUB_OUTPUT
          exit 1

  build_summary:
    name: ğŸ“Š Build Summary & Validation
    runs-on: ubuntu-latest
    needs: [test_and_coverage, validate_inputs, build_android, build_ios]
    if: always()
    
    steps:
      - name: ğŸ“Š Check Build Results
        id: check_results
        run: |
          # Get test and coverage results
          TEST_STATUS="${{ needs.test_and_coverage.result }}"
          TEST_PASSED="${{ needs.test_and_coverage.outputs.test_status }}"
          COVERAGE_MET="${{ needs.test_and_coverage.outputs.coverage_threshold_met }}"
          
          ANDROID_NEEDED="${{ needs.validate_inputs.outputs.should_build_android }}"
          IOS_NEEDED="${{ needs.validate_inputs.outputs.should_build_ios }}"
          
          ANDROID_RESULT="${{ needs.build_android.result }}"
          IOS_RESULT="${{ needs.build_ios.result }}"
          
          ALL_PASSED=true
          
          echo "## ğŸš€ Pipeline Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add test and coverage results section
          echo "### ğŸ§ª Tests & Coverage" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_STATUS" == "success" ]; then
            echo "âœ… **All tests passed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ˆ **Coverage thresholds ignored - build proceeds regardless**" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸  **Coverage analysis unavailable**" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Available Test Artifacts:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š Coverage Reports (coverage-report-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ˆ HTML Coverage Report (coverage-html-report-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“‹ Test Results (test-results-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Tests failed**" >> $GITHUB_STEP_SUMMARY
            ALL_PASSED=false
            echo "- ğŸ“‹ Test Results (test-results-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Android results
          if [ "$ANDROID_NEEDED" == "true" ]; then
            echo "### ğŸ¤– Android Builds" >> $GITHUB_STEP_SUMMARY
            if [ "$ANDROID_RESULT" == "success" ]; then
              echo "âœ… **Android builds completed successfully**" >> $GITHUB_STEP_SUMMARY
              
              # List Android artifacts
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Available Android Artifacts:**" >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ github.event.inputs.build_apk }}" == "true" ]; then
                echo "- ğŸ“¦ APK build (android-${{ github.event.inputs.environment }}-apk-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ "${{ github.event.inputs.build_aab }}" == "true" ]; then
                echo "- ğŸ“¦ AAB build (android-${{ github.event.inputs.environment }}-aab-${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ **Android builds failed**" >> $GITHUB_STEP_SUMMARY
              ALL_PASSED=false
            fi
          else
            echo "### ğŸ¤– Android Builds" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Skipped (not requested)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check iOS results
          if [ "$IOS_NEEDED" == "true" ]; then
            echo "### ğŸ iOS Builds" >> $GITHUB_STEP_SUMMARY
            if [ "$IOS_RESULT" == "success" ]; then
              echo "âœ… **iOS build completed successfully**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **iOS build failed**" >> $GITHUB_STEP_SUMMARY
              ALL_PASSED=false
            fi
          else
            echo "### ğŸ iOS Builds" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Skipped (not requested)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          echo "### ğŸ¯ Overall Status" >> $GITHUB_STEP_SUMMARY
          if [ "$ALL_PASSED" == "true" ]; then
            echo "ğŸ‰ **All builds completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ’¥ **Some builds failed**" >> $GITHUB_STEP_SUMMARY
            echo "all_passed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android**: ${{ github.event.inputs.build_android == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.build_android }}" == "true" ]; then
            echo "  - APK: ${{ github.event.inputs.build_apk == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
            echo "  - AAB: ${{ github.event.inputs.build_aab == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **iOS**: ${{ github.event.inputs.build_ios == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ï¿½ Download Instructions" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "2. Scroll down to the **Artifacts** section" >> $GITHUB_STEP_SUMMARY
          echo "3. Download the desired build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "4. Extract and install on your devices" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Ensure All Builds Passed
        if: steps.check_results.outputs.all_passed != 'true'
        run: |
          echo "âŒ Build validation failed: Not all required builds completed successfully"
          echo "Please check the individual job results above for details"
          exit 1

      - name: ğŸ‰ Build Success
        if: steps.check_results.outputs.all_passed == 'true'
        run: |
          echo "ğŸ‰ All builds completed successfully!"
          echo "âœ… Build pipeline validation passed"
          echo "ğŸ“¦ All artifacts are ready for download"
